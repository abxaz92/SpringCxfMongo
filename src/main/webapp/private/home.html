<div>
    <span><input type="button" value="Добавить" id="addBtn"/></span>
</div>

<div id="ordwindow" class="form">
    <div>Заявка на ремонт</div>
    <div>
        <div>
            <input type="hidden" id="id"/>
        </div>
        <div><label>Название</label> <input class="input" type="text" id="name"/></div>
        <div><label>Номер телефона</label> <input class="input" type="text" id="phone"/></div>
        <div><label>Imei</label> <input class="input" type="text" id="imei"/></div>
        <div><label>Стоимость</label>
            <div class="input" style="" id="cost"></div>
        </div>
        <div style="border: solid;border-radius: 11px;border-width: 0.1px;border-color: #ccc; padding: 5px">
            <label>Описание неисправности</label>
            <textarea rows="5" cols="35" name="text" id="desc"></textarea>
        </div>

        <div class="toolbar">
            <span>
                <input type="button" value="Отмена" id='ordcancel'/>
            </span>

            <span>
                <input type="button" value="Сохранить" id='ordsave'/>
            </span>
        </div>
    </div>
</div>


<div id='jqxWidget' style="font-size: 13px;font-family: Verdana; margin: auto;width: 80%;">
    <div id="jqxgrid">
    </div>
</div>
<script defer="defer">
    (function () {
        var self = this;
        self.query = {};
        var url = host + "/api/device";
        $('#name').jqxInput({height: 25, width: 150, minLength: 1, placeHolder: "Название"});
        $('#phone').jqxInput({height: 25, width: 150, minLength: 1, placeHolder: "Номер телефона клиента"});
        $('#imei').jqxInput({height: 25, width: 150, minLength: 1, placeHolder: "Imei телефона"});
        $('#cost').jqxNumberInput({height: 25, width: 150, inputMode: 'simple'});

        $("#addBtn").jqxButton({width: '40', height: '30'});
        $("#addBtn").on('click', function () {
            /*            var row = $('#jqxgrid').jqxGrid('getrowdata', $('#jqxgrid').jqxGrid('getselectedrowindex'));
             Controller.del("/api/device/" + row.id, null, function () {
             $('#jqxgrid').jqxGrid('updatebounddata');
             });*/
            $("#ordwindow").jqxWindow("open");
        })

        $("#ordwindow").jqxWindow({width: 370, height: 390, isModal: true, autoOpen: false});
        $("#ordwindow").on('close', function () {
            $('#phone').jqxInput("clear");
            $('#name').jqxInput("clear");
            $('#imei').jqxInput("clear");
            $('#cost').jqxNumberInput('clear');
            $('#id').val("");
            $('#desc').val("");
        });
        $("#ordcancel").jqxButton({width: '90px', height: '30'});
        $("#ordcancel").on('click', function () {
            $("#ordwindow").jqxWindow("close");
        })
        $("#ordsave").jqxButton({width: '90px', height: '30'});
        $("#ordsave").on('click', function () {

            var obj = {
                name: $('#name').val(),
                phone: $('#phone').val(),
                imei: $('#imei').val(),
                cost: $('#cost').val(),
                desc: $('#desc').val()
            };
            var id = $('#id').val();
            if (id && id.length > 0) {
                Controller.put("/api/device/" + id, obj, function (res) {
                    $('#jqxgrid').jqxGrid('updatebounddata');
                    $("#ordwindow").jqxWindow("close");
                });
            } else {
                Controller.post("/api/device", obj, function () {
                    $('#jqxgrid').jqxGrid('updatebounddata');
                    $("#ordwindow").jqxWindow("close");
                });
            }
        })

        var source = {
            datatype: "json",
            datafields: [
                {name: 'timestamp', type: 'date'},
                {name: 'phone', type: 'string'},
                {name: 'name', type: 'string'},
                {name: 'imei', type: 'string'},
                {name: 'cost', type: 'float'},
                {name: 'id', type: 'string'}
            ],
            beforeprocessing: function (data) {
                var source = this;
                jQuery.ajax({
                    url: encodeURI(url + "?query=" + JSON.stringify(self.query) + "&count"),
                    error: function (error) {
                        logger.error(error.responseText);
                        source.totalrecords = 0;
                    },
                    success: function (data) {
                        source.totalrecords = data;
//                        $("#count").text(source.totalrecords);
                    },
                    async: false
                });
            },
            async: true,
            filter: function () {
                self.viewModel.update();
            },
            id: 'id',
            url: url
        };

        var dataAdapter = new $.jqx.dataAdapter(source, {
            beforeSend: function (xhr, settings) {
                self.query = createQueryByData(this.data);
                settings.url = encodeURI(url + "?query=" + JSON.stringify(self.query))
                        + "&skip=" + Math.floor(this.data.recordstartindex)
                        + "&limit=" + Math.floor(this.data.recordendindex);
            }
        });
        $("#jqxgrid").jqxGrid({
            width: 740,
            height: 500,
            source: dataAdapter,
            sortable: true,
            virtualmode: true,
            filterable: true,
            altrows: true,
            columnsresize: true,
            scrollmode: 'deferred',
            rendergridrows: function (params) {
                return params.data;
            },
            columns: [
                {
                    text: 'Дата',
                    datafield: 'timestamp',
                    width: 150,
                    cellsformat: 'yyyy-MM-dd HH:mm'
                },
                {
                    text: 'Название',
                    datafield: 'name',
                    cellsalign: 'left',
                    align: 'left',
                    width: 270
                },
                {
                    text: 'Imei',
                    datafield: 'imei',
                    cellsalign: 'left',
                    align: 'left',
                    width: 100
                },
                {
                    text: 'Номер телефона',
                    datafield: 'phone',
                    cellsalign: 'left',
                    align: 'left',
                    width: 130
                },
                {
                    text: 'Цена',
                    datafield: 'cost',
                    cellsalign: 'left',
                    align: 'left',
                    width: 90
                }
            ]
        });
        $('#jqxgrid').on('rowdoubleclick', function (event) {
            $("#ordwindow").jqxWindow("open");
            var row = $('#jqxgrid').jqxGrid('getrowdata', event.args.rowindex);
            Controller.get("/api/device/" + row.id, function (data) {
                $("#id").val(data.id)
                $('#phone').jqxInput('val', !data.phone ? "" : data.phone);
                $('#name').jqxInput('val', !data.name ? "" : data.name);
                $('#cost').jqxNumberInput('val', !data.cost ? "" : data.cost);
                $('#imei').jqxInput('val', !data.imei ? "" : data.imei);
                $('#desc').val(!data.desc ? "" : data.desc);
            });

            $("#jqxgrid").on("pagechanged", function (event) {

            });
            $("#jqxgrid").on("pagesizechanged", function (event) {

            });

        });
    }());
    function unload() {
        $("#ordwindow").jqxWindow('destroy');
    }
</script>